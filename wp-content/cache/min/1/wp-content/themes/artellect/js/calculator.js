let interval;function numberWithSpaces(x){if(x===null||x===undefined||x==='')return'';const str=x.toString().replace(/\s+/g,'');const num=parseFloat(str);if(isNaN(num))return str;const parts=num.toString().split('.');parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');return parts.join('.')}
function setupTabs(){const tabs=document.querySelectorAll('.ads-calculator__tab');const blocks=document.querySelectorAll('.ads-calculator__block');tabs.forEach(tab=>{tab.addEventListener('click',function(){const tabNum=this.dataset.calcTab;tabs.forEach(t=>t.classList.remove('active'));this.classList.add('active');blocks.forEach(block=>{block.classList.remove('active')});const targetBlock=document.querySelector(`[data-calc-block="${tabNum}"]`);if(targetBlock){targetBlock.classList.add('active')}
switch(tabNum){case '1':processcalc();break;case '2':processcalc2();break;case '3':processcalc3();break}})})}
function setupTooltips(){document.addEventListener('click',function(e){if(e.target.classList.contains('tips__btn')||e.target.textContent==='?'){const tipBtn=e.target;const tipMessage=tipBtn.nextElementSibling;if(tipMessage&&tipMessage.classList.contains('tips__message')){tipMessage.style.display=tipMessage.style.display==='none'?'block':'none'}}})}
function setupAllInputs(){function handleBlurFormatting(input){if(!input)return;const value=input.value;if(!value&&value!=='0')return;const label=input.previousElementSibling;const isPercentage=label&&(label.textContent.includes('%')||label.classList.contains('percentage-label')||input.classList.contains('percentage-field'));const numValue=getNumericValue(value);if(numValue!==0||value==='0'){if(isPercentage){input.value=numValue}else{input.value=numberWithSpaces(numValue)}}}
function setupCalculatorInputs(selector,handler){const inputs=document.querySelectorAll(selector);inputs.forEach(input=>{input.removeEventListener('input',handler);input.removeEventListener('change',handler);input.removeEventListener('blur',handleBlurFormatting);input.addEventListener('input',function(){handler()});input.addEventListener('change',handler);input.addEventListener('blur',function(){handleBlurFormatting(this);handler()});input.addEventListener('focus',function(){const value=this.value;if(value){this.value=value.replace(/\s+/g,'')}
interval=setInterval(handler,200)});input.addEventListener('blur',function(){clearInterval(interval);handleBlurFormatting(this);handler()})})}
setupCalculatorInputs('[data-calc-block="1"] .ads-calculator__input',processcalc);setupCalculatorInputs('[data-calc-block="2"] .ads-calculator__input',processcalc2);setupCalculatorInputs('[data-calc-block="3"] .ads-calculator__input',processcalc3)}
function getNumericValue(value){if(value===null||value===undefined||value==='')return 0;if(typeof value==='number')return value;const str=value.toString();let cleaned=str.replace(/\s+/g,'').replace(/[^\d.,-]/g,'').replace(/,/g,'.');const parts=cleaned.split('.');if(parts.length>2){cleaned=parts[0]+'.'+parts.slice(1).join('')}
const result=parseFloat(cleaned);return isNaN(result)?0:result}
function processcalc(){const block=document.querySelector('[data-calc-block="1"]');if(!block)return;const inputs=block.querySelectorAll('.ads-calculator__input');const leads=getNumericValue(inputs[0]?.value);const margin=getNumericValue(inputs[1]?.value);const avgCheck=getNumericValue(inputs[2]?.value);const romi=getNumericValue(inputs[3]?.value);const conversion=getNumericValue(inputs[4]?.value);const results=block.querySelectorAll('.ads-calculator__result p span');if(leads>0&&avgCheck>0&&margin>0&&margin<=100&&romi>0&&conversion>0&&conversion<=100){const clientsPerMonth=Math.ceil((leads/100)*conversion);const revenue=Math.ceil(clientsPerMonth*avgCheck);const marketingBudget=Math.ceil(revenue*(100/(romi+100)));const cac=Math.ceil(marketingBudget/clientsPerMonth);const cpl=Math.ceil(marketingBudget/leads);const grossProfit=Math.ceil((revenue/100)*margin-marketingBudget);if(results[0])
results[0].textContent=numberWithSpaces(marketingBudget)+' ₽';if(results[1])results[1].textContent=numberWithSpaces(cac)+' ₽';if(results[2])results[2].textContent=numberWithSpaces(cpl)+' ₽';if(results[3])results[3].textContent=numberWithSpaces(clientsPerMonth);if(results[4])results[4].textContent=numberWithSpaces(revenue)+' ₽';if(results[5])
results[5].textContent=numberWithSpaces(grossProfit)+' ₽';const button=block.querySelector('.button-decore');const result6=results[5]?.closest('.ads-calculator__result');if(grossProfit<=0){if(result6){result6.classList.remove('positive');result6.classList.add('negative')}
if(button){button.style.opacity='0.2';button.style.cursor='not-allowed'}}else{if(result6){result6.classList.add('positive');result6.classList.remove('negative')}
if(button){button.style.opacity='1';button.style.cursor='pointer'}}
const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='1'}}else{results.forEach(span=>{if(span.textContent.includes('₽')){span.textContent='— ₽'}else{span.textContent='—'}});const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='0.3'}}}
function processcalc2(){const block=document.querySelector('[data-calc-block="2"]');if(!block)return;const inputs=block.querySelectorAll('.ads-calculator__input');const budget=getNumericValue(inputs[0]?.value);const avgCheck=getNumericValue(inputs[1]?.value);const margin=getNumericValue(inputs[2]?.value);const romi=getNumericValue(inputs[3]?.value);const conversion=getNumericValue(inputs[4]?.value);const results=block.querySelectorAll('.ads-calculator__result p span');if(budget>0&&avgCheck>0&&margin>0&&margin<=100&&romi>0&&conversion>0&&conversion<=100){const revenue=Math.ceil((budget/100)*romi+budget);const clients=Math.ceil(revenue/avgCheck);const leads=Math.ceil(clients*(100/conversion));const cpl=Math.ceil(budget/leads);const cac=Math.ceil(budget/clients);const profit=Math.ceil((revenue/100)*margin-budget);if(results[0])results[0].textContent=numberWithSpaces(leads);if(results[1])results[1].textContent=numberWithSpaces(clients);if(results[2])results[2].textContent=numberWithSpaces(cpl)+' ₽';if(results[3])results[3].textContent=numberWithSpaces(cac)+' ₽';if(results[4])results[4].textContent=numberWithSpaces(revenue)+' ₽';if(results[5])results[5].textContent=numberWithSpaces(profit)+' ₽';const button=block.querySelector('.button-decore');const result6=results[5]?.closest('.ads-calculator__result');if(profit<=0){if(result6){result6.classList.remove('positive');result6.classList.add('negative')}}else{if(result6){result6.classList.add('positive');result6.classList.remove('negative')}}
const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='1'}}else{results.forEach(span=>{if(span.textContent.includes('₽')){span.textContent='— ₽'}else{span.textContent='—'}});const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='0.3'}}}
function processcalc3(){const block=document.querySelector('[data-calc-block="3"]');if(!block)return;const inputs=block.querySelectorAll('.ads-calculator__input');const revenue=getNumericValue(inputs[0]?.value);const avgCheck=getNumericValue(inputs[1]?.value);const margin=getNumericValue(inputs[2]?.value);const marketingShare=getNumericValue(inputs[3]?.value);const conversion=getNumericValue(inputs[4]?.value);const results=block.querySelectorAll('.ads-calculator__result p span');if(revenue>0&&avgCheck>0&&margin>0&&margin<=100&&marketingShare>0&&marketingShare<=100&&conversion>0&&conversion<=100){const budget=Math.ceil((revenue/100)*marketingShare);const cac=Math.ceil((avgCheck/100)*marketingShare);const cpl=Math.ceil((((avgCheck/100)*marketingShare)/100)*conversion);const clients=Math.ceil(revenue/avgCheck);const leads=Math.ceil(clients*(100/conversion));const profit=Math.ceil((revenue/100)*margin-budget);if(results[0])results[0].textContent=numberWithSpaces(budget)+' ₽';if(results[1])results[1].textContent=numberWithSpaces(cac)+' ₽';if(results[2])results[2].textContent=numberWithSpaces(cpl)+' ₽';if(results[3])results[3].textContent=numberWithSpaces(clients)+' ₽';if(results[4])results[4].textContent=numberWithSpaces(leads)+' ₽';if(results[5])results[5].textContent=numberWithSpaces(profit)+' ₽';const button=block.querySelector('.button-decore');const result6=results[5]?.closest('.ads-calculator__result');if(profit<=0){if(result6){result6.classList.remove('positive');result6.classList.add('negative')}}else{if(result6){result6.classList.add('positive');result6.classList.remove('negative')}}
const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='1'}}else{results.forEach(span=>{if(span.textContent.includes('₽')){span.textContent='— ₽'}else{span.textContent='—'}});const resultsBlock=block.querySelector('.ads-calculator__results');if(resultsBlock){resultsBlock.style.opacity='0.3'}}}
document.addEventListener('DOMContentLoaded',function(){console.log('Инициализация калькулятора...');setupAllInputs();setupTabs();setupTooltips();processcalc();processcalc2();processcalc3();console.log('Калькулятор готов!')})